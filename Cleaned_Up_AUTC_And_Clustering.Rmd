---
title: "Cluster_CoRa"
output: html_document
date: '2022-09-26'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, libraries}
library(stringr)
library(cluster)
library(seriation)
library(ggplot2)
```

```{r, functions}
Comparison <- function(a, b){
  if(is.nan(a) & is.nan(b)){
    return(0)
  }else if(is.nan(a) | is.nan(b)){
    return(1)
  }else{
    return(abs(a - b))
  }
}

AUTC <- function(Data){
  AreaMatrix <- matrix(0, nrow = ncol(Data), ncol = ncol(Data))
  AreaMatrix[lower.tri(AreaMatrix, diag = T)] <- unlist(sapply(c(1:(ncol(Data) - 1)), function(a) apply(sapply(Data[,(a):ncol(Data)], function(b) mapply(Comparison, Data[,a], b)), 2, sum)))
  AreaMatrix[upper.tri(AreaMatrix)] <- t(AreaMatrix)[upper.tri(AreaMatrix)]
  return(AreaMatrix)
}
```

```{r, set_WD}
setwd("C:/Users/ese_1/OneDrive/Documentos/CoRa/")
```

```{r, Test_Data}
ATFv1 <- read.table(file = "OUT_ExSSs_ATFv1_SmallSet_mY_mY.txt", header = T)
ATFv1Names <- paste0("ATFv1_", 1:nrow(ATFv1))
ATFv2 <- read.table(file = "OUT_ExSSs_ATFv2_SmallSet_mY_mY.txt", header = T)
ATFv2Names <- paste0("ATFv2_", 1:nrow(ATFv2))
FADv1 <- read.table(file = "OUT_ExSSs_FADv1_SmallSet_mY_mY.txt", header = T)
FADv1Names <- paste0("FADv1_", 1:nrow(FADv1))
FADv2 <- read.table(file = "OUT_ExSSs_FADv2_SmallSet_mY_mY.txt", header = T)
FADv2Names <- paste0("FADv2_", 1:nrow(FADv2))
CoRas <- as.data.frame(t(rbind(ATFv1[, 2:ncol(ATFv1)], ATFv2[, 2:ncol(ATFv2)], FADv1[, 2:ncol(FADv1)], FADv2[, 2:ncol(FADv2)])))
colnames(CoRas) <- c(ATFv1Names, ATFv2Names, FADv1Names, FADv2Names)
rm(ATFv1, ATFv2, FADv1, FADv2, ATFv1Names, ATFv2Names, FADv1Names, FADv2Names)
```

```{r ATFv2_BNFv2_1250Set1}
ATFv2 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY.txt", header = T)
ATFv2_71 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_71.txt", header = T)
ATFv2_109 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_109.txt", header = T)
ATFv2_285 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_285.txt", header = T)
ATFv2_373 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_373.txt", header = T)
ATFv2_426 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_426.txt", header = T)
ATFv2_503 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_503.txt", header = T)
ATFv2_625 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_625.txt", header = T)
ATFv2_664 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_664.txt", header = T)
ATFv2_719 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_719.txt", header = T)
ATFv2_856 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_856.txt", header = T)
ATFv2_859 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_859.txt", header = T)
ATFv2_904 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_904.txt", header = T)
ATFv2_936 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_936.txt", header = T)
ATFv2_947 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_947.txt", header = T)
ATFv2_979 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_979.txt", header = T)
ATFv2_982 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_982.txt", header = T)
ATFv2_1004 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_1004.txt", header = T)
ATFv2_1182 <- read.table(file = "OUT_ExSSs_ATFv2_1250Set1_mY_mY_From_1182.txt", header = T)
ATFv2_Merged <- rbind(ATFv2, ATFv2_71, ATFv2_109, ATFv2_285, ATFv2_373, ATFv2_426, ATFv2_503, ATFv2_625, ATFv2_664, ATFv2_719, ATFv2_856, ATFv2_859, ATFv2_904, ATFv2_936, ATFv2_947, ATFv2_979, ATFv2_982, ATFv2_1004, ATFv2_1182)
BNFv2 <- read.table(file = "OUT_ExSSs_BNFv2_1250Set1_mY_mY.txt", header = T)
rm(ATFv2, ATFv2_71, ATFv2_109, ATFv2_285, ATFv2_373, ATFv2_426, ATFv2_503, ATFv2_625, ATFv2_664, ATFv2_719, ATFv2_856, ATFv2_859, ATFv2_904, ATFv2_936, ATFv2_947, ATFv2_979, ATFv2_982, ATFv2_1004, ATFv2_1182)
ATFv2_Names <- paste0("ATFv2_", 1:nrow(ATFv2_Merged))
BNFv2_Names <- paste0("BNFv2_", 1:nrow(BNFv2))
CoRas <- as.data.frame(t(rbind(ATFv2_Merged[, 2:ncol(ATFv2_Merged)], BNFv2[, 2:ncol(BNFv2)])))
CoRas[CoRas > 1] <- NaN
colnames(CoRas) <- c(ATFv2_Names, BNFv2_Names)
rm(ATFv2_Merged, BNFv2, ATFv2_Names, BNFv2_Names)
```

```{r, calculation of AUTC}
AUTC <- AUTC(CoRas)
```

```{r, MaxKCalc}
set.seed(1337)
colnames(AUTC) <- colnames(CoRas)
rownames(AUTC) <- colnames(AUTC)
Models <- unique(str_split_fixed(colnames(AUTC), "_", 2)[,1])
#We do this first sapply to obtain the indexes for which column and row have the same starting part of their name, which means they're an "IntraModelComparison"
Indexes <- sapply(Models, function(M) grepl(paste0(M, "_"), colnames(AUTC)))
#This line skips a step by doing 2 "lapply" nested. The inner one produces the partial tables with only data from a single Model being compared within itself. The second one feeds that partial table into the clusGap() function
#While I could technically skip this variable assignation and write the whole line in the following one, in place of "ModelsKCalc", it's already hard enough to read as is.
ModelsKCalc <- lapply(lapply(Models, function(M1) AUTC[Indexes[, M1], Indexes[, M1]]), function(M2) clusGap(M2, FUN = kmeans, nstart = 25, K.max = 15, B = 50))
names(ModelsKCalc) <- Models
#The innermost sapply will calculate the function of maxSE with every possible metric. The second sapply does that, for every SE.factor we determined. The lapply makes it so it runs for every ModelsKCalc object, which is basically every Model
MaxK <- sum(sapply(ModelsKCalc, function(Model) maxSE(Model$Tab[, "gap"], Model$Tab[, "SE.sim"], method = "firstSEmax", SE.factor = 1)))
MaxK
```

```{r, clustering_of_the_whole}
WholeK <- clusGap(AUTC, FUN = kmeans, nstart = 25, K.max = MaxK, B = 50)
WholeK<- maxSE(WholeK$Tab[,"gap"], WholeK$Tab[, "SE.sim"], method = "firstSEmax", SE.factor = 1)
```

```{r, clustering_time}
DissimMat <- AUTC

pamAUTC <- pam(DissimMat, diss = T, k = MaxK)
ClusterMaxK <- pamAUTC$clustering
DissimMat <- DissimMat[names(sort(ClusterMaxK)), names(sort(ClusterMaxK))]
MaxKdissplot <- ggdissplot(as.dist(DissimMat), labels = sort(ClusterMaxK), method = NA, cluster_labels = T, cluster_lines = T, diag = F) + scale_fill_gradient(low = "darkorchid4", high = "white", na.value = "grey75") + ggtitle("Individual Model Clustering")

pamAUTC <- pam(DissimMat, diss = T, k = WholeK)
ClusterWholeK <- pamAUTC$clustering
DissimMat <- DissimMat[names(sort(ClusterWholeK)), names(sort(ClusterWholeK))]
WholeKdissplot <- ggdissplot(as.dist(DissimMat), labels = sort(ClusterWholeK), method = NA, cluster_labels = T, cluster_lines = T, diag = F) + scale_fill_gradient(low = "darkorchid4", high = "white", na.value = "grey75") + ggtitle("AllxAll Clustering")

MaxKdissplot
WholeKdissplot
```

```{r, graphing_Cluster_Members}
ClusterGraphing <- function(data, ClusNum, Cluster, title){
  Partial = tidyr::gather(data[, names(Cluster[which(Cluster == ClusNum)])])
  Partial$step <- rep(seq(from = 0, to = 0.01, by = 1/60000), ncol(data[, names(Cluster[which(Cluster == ClusNum)])]))
  b <- ggplot(data = Partial, aes(x = step, y = value, col = key)) + geom_line(size = 1.5) + theme(legend.position = "none") + ylab(expression(paste("CoRa"[mu[Y]%in%theta], "("*mu[Y],")"))) + ggtitle(title)
  b
}

ClusterGraphing(CoRas, 11, ClusterWholeK, "Cluster 11 according to AllxAll Clustering")
```

```{r Test Realm, eval=FALSE, include=FALSE}

```

